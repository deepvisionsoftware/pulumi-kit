name: Publish to NPM

on:
  push:
    branches:
      - v*

env:
  PACKAGE_NAME: '@pcg/pulumi-kit'

permissions:
  id-token: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-24.04
    outputs:
      should-publish: ${{ steps.check.outputs.should-publish }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v6

      - id: check
        name: Check published version
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const packageJson = JSON.parse(await fs.promises.readFile('./package.json', 'utf8'));
            const currentVersion = packageJson.version;

            console.log(`ğŸ“¦ Local version: ${currentVersion}`);

            const response = await fetch('https://registry.npmjs.org/${{ env.PACKAGE_NAME }}?fields=versions');
            const data = await response.json();

            const versionExists = data.versions && currentVersion in data.versions;

            if (versionExists) {
              console.log(`ğŸš§ Version ${currentVersion} already exists in npm registry. Skipping publish.`);
              core.setOutput('should-publish', 'false');
            } else {
              console.log(`ğŸ‘·â¬†ï¸ Version ${currentVersion} does not exist in npm registry. Will publish.`);
              core.setOutput('should-publish', 'true');
            }

  publish:
    runs-on: ubuntu-24.04
    needs: check
    if: needs.check.outputs.should-publish == 'true'
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v6

      - id: setup-pnpm
        name: Setup pnpm
        uses: pnpm/action-setup@v4

      - id: setup-node
        name: Setup Node.js v24
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - id: install
        name: Install dependencies
        run: pnpm install

      - id: build
        name: Build library
        run: pnpm run build

      - id: publish
        name: Publish to NPM
        run: pnpm publish --access public
